<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Ä—ã–±–æ–ª–æ–≤–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç –ú–∏—Ö–∞–ª—ã—á–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=5c8b83d1-0cfc-45c7-960c-0422eea91c23&lang=ru_RU" type="text/javascript"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; }
        .header { 
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white; 
            padding: 10px;
            text-align: center;
        }
        .header h1 { 
            font-size: 0.8em;
            margin-bottom: 5px; 
        }
        .header p { 
            font-size: 0.6em;
            opacity: 0.9; 
        }
        #map { 
            width: 100%; 
            height: calc(100vh - 80px);
        }
        .balloon-content {
            max-width: 300px;
            padding: 10px;
        }
        .balloon-photo {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        .balloon-description {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 14px;
        }
        .balloon-source {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 12px;
        }
        .balloon-source a {
            color: #3498db;
            text-decoration: none;
        }
        .balloon-source a:hover {
            text-decoration: underline;
        }
        .balloon-coords {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .anonymous-user {
            color: #666;

        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Ä—ã–±–æ–ª–æ–≤–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç –ú–∏—Ö–∞–ª—ã—á–∞</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏ –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ</p>
    </div>
    
    <div id="map"></div>

    <script type="text/javascript">
        let map;
        let objectManager;

        ymaps.ready(init);

        function init() {
            map = new ymaps.Map('map', {
                center: [55.7558, 37.6173],
                zoom: 10
            });

            objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 32,
                clusterDisableClickZoom: true
            });

            objectManager.objects.options.set({
                preset: 'islands#blueFishingCircleIcon',
                balloonContentLayout: balloonLayout
            });

            objectManager.clusters.options.set({
                preset: 'islands#blueClusterIcons'
            });

            map.geoObjects.add(objectManager);
            loadFishingPlaces();
        }

        function loadFishingPlaces() {
            fetch('./places.json')
                .then(response => response.json())
                .then(places => {
                    const features = places.map(place => ({
                        type: 'Feature',
                        id: place.id || Math.random(),
                        geometry: {
                            type: 'Point',
                            coordinates: place.coords
                        },
                        properties: {
                            balloonContent: createBalloonContent(place),
                            hintContent: 'üé£ –ú–µ—Å—Ç–æ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏',
                            ...place
                        }
                    }));

                    objectManager.add(features);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                });
        }

        function createBalloonContent(place) {
            let content = '<div class="balloon-content"><div style="font-weight: bold; margin-bottom: 8px; color: #2c3e50;">üé£ –ú–µ—Å—Ç–æ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏</div>';

            if (place.description) {
                // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
                const escapedDescription = place.description
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
                content += '<div class="balloon-description">' + escapedDescription + '</div>';
            }

            if (place.photo_url) {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ URL (—Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã)
                const safePhotoUrl = place.photo_url.replace(/[<>"']/g, '');
                content += '<img src="' + safePhotoUrl + '" alt="–§–æ—Ç–æ –º–µ—Å—Ç–∞" class="balloon-photo" onerror="this.style.display=\'none\'">';
            }

            if (place.source_link) {
                if (place.is_anonymous === true || place.source_link.url === "") {
                    // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    const safeText = place.source_link.text
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    content += '<div class="balloon-source"><span class="anonymous-user">üë§ ' + safeText + '</span></div>';
                } else {
                    // –ü—É–±–ª–∏—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å—Å—ã–ª–∫–æ–π
                    const safeUrl = place.source_link.url.replace(/[<>"']/g, '');
                    const safeText = place.source_link.text
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    content += '<div class="balloon-source">üìç <b>–î–æ–±–∞–≤–∏–ª:</b> <a href="' + safeUrl + '" target="_blank" style="color: #3498db;">' + safeText + '</a></div>';
                }
            }

            content += '<div class="balloon-coords"><b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</b> ' + place.coords[0].toFixed(6) + ', ' + place.coords[1].toFixed(6) + '</div></div>';

            return content;
            }

        var balloonLayout = ymaps.templateLayoutFactory.createClass(
            '<div class="balloon-content">$[properties.balloonContent]</div>'
        );
    </script>
</body>
</html>