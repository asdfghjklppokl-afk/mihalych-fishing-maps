<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Ä—ã–±–æ–ª–æ–≤–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç –ú–∏—Ö–∞–ª—ã—á–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=5c8b83d1-0cfc-45c7-960c-0422eea91c23&lang=ru_RU" type="text/javascript"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { 
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white; 
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { 
            font-size: 0.8em;
            margin-bottom: 5px; 
        }
        .header p { 
            font-size: 0.6em;
            opacity: 0.9; 
        }
        #map { 
            width: 100%; 
            height: calc(100vh - 80px);
        }
        .controls {
            position: absolute;
            top: 90px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        .search-box {
            display: flex;
            gap: 5px;
        }
        .search-box input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-box button {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group button {
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .control-group button:hover {
            background: #e9ecef;
        }
        .control-group button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .balloon-content {
            max-width: 300px;
            padding: 10px;
        }
        .balloon-photo {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        .balloon-description {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 14px;
        }
        .balloon-source {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 12px;
        }
        .balloon-source a {
            color: #3498db;
            text-decoration: none;
        }
        .balloon-source a:hover {
            text-decoration: underline;
        }
        .balloon-coords {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .route-button {
            background: #27ae60 !important;
            color: white !important;
            border: none !important;
            margin-top: 5px;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Ä—ã–±–æ–ª–æ–≤–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç –ú–∏—Ö–∞–ª—ã—á–∞</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏ –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ</p>
    </div>
    
    <div id="map"></div>
    
    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å–∞...">
            <button onclick="searchLocation()">üîç</button>
        </div>
        
        <div class="control-group">
            <button onclick="locateMe()">üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
            <button onclick="resetNorth()">üß≠ –ù–∞ —Å–µ–≤–µ—Ä</button>
        </div>
        
        <div class="control-group">
            <button onclick="setMapType('map')" id="btnMap" class="active">üó∫Ô∏è –°—Ö–µ–º–∞</button>
            <button onclick="setMapType('satellite')" id="btnSatellite">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫</button>
            <button onclick="setMapType('hybrid')" id="btnHybrid">üåç –ì–∏–±—Ä–∏–¥</button>
        </div>
        
        <div class="control-group">
            <button onclick="toggleTraffic()" id="btnTraffic">üö¶ –ü—Ä–æ–±–∫–∏</button>
        </div>
    </div>

    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>

    <script type="text/javascript">
        let map;
        let objectManager;
        let currentMapType = 'map';
        let myLocationPlacemark;
        let trafficLayer;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(init);

        function init() {
            document.getElementById('loading').style.display = 'none';
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –º–∞—Å—à—Ç–∞–±–∞
            map = new ymaps.Map('map', {
                center: [55.7558, 37.6173],
                zoom: 10,
                controls: ['zoomControl', 'fullscreenControl'],
                minZoom: 5,
                maxZoom: 18
            });

            // –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –º–µ—Ç–æ–∫
            objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 32,
                clusterDisableClickZoom: true
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–ª—É–Ω–æ–≤ –∏ —Ö–∏–Ω—Ç–æ–≤ –¥–ª—è objectManager
            objectManager.objects.options.set({
                preset: 'islands#blueFishingCircleIcon',
                balloonContentLayout: balloonLayout
            });

            objectManager.clusters.options.set({
                preset: 'islands#blueClusterIcons'
            });

            // –î–æ–±–∞–≤–ª—è–µ–º objectManager –Ω–∞ –∫–∞—Ä—Ç—É
            map.geoObjects.add(objectManager);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–∞—Ö
            loadFishingPlaces();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –ø–æ Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ä—ã–±–æ–ª–æ–≤–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        function loadFishingPlaces() {
            fetch('./places.json')
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    return response.json();
                })
                .then(places => {
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${places.length} —Ç–æ—á–µ–∫ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏`);
                    
                    const features = places.map(place => ({
                        type: 'Feature',
                        id: place.id || Math.random(),
                        geometry: {
                            type: 'Point',
                            coordinates: place.coords
                        },
                        properties: {
                            balloonContent: createBalloonContent(place),
                            hintContent: 'üé£ –ú–µ—Å—Ç–æ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏',
                            ...place
                        }
                    }));

                    objectManager.add(features);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    document.getElementById('loading').innerHTML = 
                        '<div style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –±–∞–ª—É–Ω–∞
        function createBalloonContent(place) {
            let content = `
                <div class="balloon-content">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #2c3e50;">
                        üé£ –ú–µ—Å—Ç–æ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏
                    </div>
            `;

            if (place.description) {
                content += `
                    <div class="balloon-description">${place.description}</div>
                `;
            }

            if (place.photo_url) {
                content += `
                    <img src="${place.photo_url}" alt="–§–æ—Ç–æ –º–µ—Å—Ç–∞" class="balloon-photo" 
                         onerror="this.style.display='none'">
                `;
            }

            if (place.source_link) {
                content += `
                    <div class="balloon-source">
                        <a href="${place.source_link.url}" target="_blank" rel="noopener">
                            ${place.source_link.text || '–ò—Å—Ç–æ—á–Ω–∏–∫'}
                        </a>
                    </div>
                `;
            }

            content += `
                    <div class="balloon-coords">
                        <b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</b> ${place.coords[0].toFixed(6)}, ${place.coords[1].toFixed(6)}
                    </div>
                    <button class="route-button" onclick="openRoute(${place.coords[0]}, ${place.coords[1]})">
                        üìç –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
                    </button>
                </div>
            `;

            return content;
        }

        // –ö–∞—Å—Ç–æ–º–Ω—ã–π layout –¥–ª—è –±–∞–ª—É–Ω–æ–≤
        var balloonLayout = ymaps.templateLayoutFactory.createClass(
            '<div class="balloon-content">$[properties.balloonContent]</div>'
        );

        // –ü–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            ymaps.geocode(query).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                if (firstGeoObject) {
                    const coords = firstGeoObject.geometry.getCoordinates();
                    map.setCenter(coords, 12);
                } else {
                    alert('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                }
            }).catch(function(error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
            });
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        function locateMe() {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–µ—Ç–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (myLocationPlacemark) {
                        map.geoObjects.remove(myLocationPlacemark);
                    }

                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
                    myLocationPlacemark = new ymaps.Placemark(coords, {
                        hintContent: '–í—ã –∑–¥–µ—Å—å',
                        balloonContent: '–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
                    }, {
                        preset: 'islands#greenCircleIcon'
                    });

                    map.geoObjects.add(myLocationPlacemark);
                    map.setCenter(coords, 14);
                },
                function(error) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                    console.error('Geolocation error:', error);
                }
            );
        }

        // –°–±—Ä–æ—Å –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ —Å–µ–≤–µ—Ä
        function resetNorth() {
            map.setCenter(map.getCenter(), map.getZoom());
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
        function setMapType(type) {
            currentMapType = type;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.getElementById('btnMap').classList.remove('active');
            document.getElementById('btnSatellite').classList.remove('active');
            document.getElementById('btnHybrid').classList.remove('active');
            document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –∫–∞—Ä—Ç—ã
            map.setType('yandex#' + type);
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±–æ–∫
        function toggleTraffic() {
            const btn = document.getElementById('btnTraffic');
            
            if (!trafficLayer) {
                // –í–∫–ª—é—á–∞–µ–º –ø—Ä–æ–±–∫–∏
                trafficLayer = new ymaps.TrafficLayer({ providerKey: 'traffic#actual' });
                map.layers.add(trafficLayer);
                btn.classList.add('active');
                btn.innerHTML = 'üö¶ –ü—Ä–æ–±–∫–∏ (–≤–∫–ª)';
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º –ø—Ä–æ–±–∫–∏
                map.layers.remove(trafficLayer);
                trafficLayer = null;
                btn.classList.remove('active');
                btn.innerHTML = 'üö¶ –ü—Ä–æ–±–∫–∏';
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö
        function openRoute(lat, lon) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        // –ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ —Ç–æ—á–∫–∏
                        const url = `https://yandex.ru/maps/?rtext=${userLat},${userLon}~${lat},${lon}&rtt=auto`;
                        window.open(url, '_blank');
                    },
                    function(error) {
                        // –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–æ—á–∫—É
                        const url = `https://yandex.ru/maps/?rtext=~${lat},${lon}`;
                        window.open(url, '_blank');
                    }
                );
            } else {
                // –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                const url = `https://yandex.ru/maps/?rtext=~${lat},${lon}`;
                window.open(url, '_blank');
            }
        }
    </script>
</body>
</html>